# === setup ===
language: python
python:
  - "2.7"
  - "3.5"
  - "3.6"
cache:
  - pip
  - directories:
      - $HOME/conda
      - $HOME/downloads
# includes PR when base branch = master
if: branch = master OR tag IS present
env:
  global:
    - CONDA_HOME=$HOME/conda
    - DOWNLOAD_CACHE=$HOME/downloads
    - secure: lzPPXuRTlqLHl2MCAUuy7ROrewSwPFGGKqbADo7npQ4jqVMAb/TQ5PTzIi4IAIvsv817dNj5WSAd39hsp1zSlE1R2jLtbxGEVqwcjTqSv9VStGascRQnCW1hcoSKYqESweEhtdIcH+uXpV8qnDsUWB6YIIP2VjgWPMfSPZPynFKC0IqZm2sFsqDEJJHr3QM5iN3i3Z9GrEIrBEEpoaf0yak5u8LjqoGSaY8ISPGWipBJYn7i/r/+sZpirFXbZRJmI4ljsaHi0tysNWdANOIf7S2+Dy/oGNn/3Br0OMJ5snFe/n6Uf4GcmPGDc1c86oN0FpGcoNSA+lCUPMASghOGwVqBhMjX+qAZZfzEbCGtr2j/MhcpETMO3S9oqelw4CcbZRXxP2Y20L+KGNOCSt3SC4/HdKj5MWRQGUnIZbT9C2Tpn2wTffpVRoKvhik/6UU8/KT12LSwDhjjrfqLgCEFLqH1nBL2Mopkj/eOwQbZ66nZmthrAF7/c+vaB38LWoqBIZi/fOwo6+kt947d1bW6UX6Z1KnCNLN2KO064Hjn+SHb1gAes0JIXIZE7af1Gti2dKmUL4a5eoYyU5vCLlp2nq5yxEtTUdJKZ1UVnkDqRtSaT0F3FgLypbFqi+qZ6AtygxKqplMjeAGhvVSqZTPqRupP1ac/KBBCvMzG8pkfXWs=
  matrix:
    - TEST_TARGET=test-local    START_TARGET=
    - TEST_TARGET=test-remote   START_TARGET=start
    - TEST_TARGET=coverage      START_TARGET=
addons:
  postgresql: "9.6"
postgres:
  adapter: postgresql
  database: magpie
  username: postgres
  password: qwerty
notifications:
  email: false
# === pipeline ===
before_install:
  - python -V
  - uname -a
  - lsb_release -a
  - export PYTHON_VERSION=${TRAVIS_PYTHON_VERSION}
  - export CONDA_ENV=magpie-${TRAVIS_PYTHON_VERSION}
  - export CONDA_PREFIX=$HOME/conda/envs/magpie-${TRAVIS_PYTHON_VERSION}
  - export PATH=${CONDA_HOME}/bin:$PATH
  - hash -r
  - env
  - make conda-base
  - make install-sys
  #==== magpie env and constants ===
  - mkdir -p ./env
  - cp -f ./ci/magpie.env ./env/magpie.env
install:
  - make install-pkg install-dev
  - make version
  - ${CONDA_PREFIX}/bin/pip freeze
before_script:
  - psql -c 'create database magpie;' -U postgres
  - echo ${CONDA_PREFIX}
  - echo ${CONDA_ENV}
  - export PYTHON_VERSION=${TRAVIS_PYTHON_VERSION}
  - export CONDA_ENV=magpie-${TRAVIS_PYTHON_VERSION}
  - export CONDA_PREFIX=${HOME}/conda/envs/magpie-${TRAVIS_PYTHON_VERSION}
  - export PATH=${CONDA_HOME}/bin:${PATH}
  - hash -r
  - env
script:
  # linting tests
  - |
    if [ "${TRAVIS_PYTHON_VERSION}" == "3.6" ]; then
      make check
    fi
  # unit/functional tests
  - make stop ${START_TARGET}
  - make ${TEST_TARGET}
  # smoke test the docker image
  - |
    if [ "${TRAVIS_PYTHON_VERSION}" == "3.6" ]; then
      make test-docker
    fi
after_script:
  - make stop
after_success:
  - bash <(curl -s https://codecov.io/bash) || echo "Codecov did not collect coverage reports"
  - source ${CONDA_PREFIX}/bin/activate ${CONDA_ENV} && python-codacy-coverage -r reports/coverage.xml
